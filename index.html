<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Procedural Puzzle Lab ‚Äî Chrono Logic</title>
<style>
  :root{--bg:#071422;--panel:#0b1a2a;--glass:rgba(255,255,255,0.04);--accent:#00f2ff;}
  html,body{height:100%;margin:0;background:radial-gradient(1000px 600px at 10% 0%,#072033 0%, #04111a 50%, #020815 100%);font-family:Inter,Segoe UI,Arial,sans-serif;color:#eaf6ff}
  .app{max-width:1200px;margin:18px auto;padding:18px;display:flex;gap:18px}
  .left{flex:1;min-width:540px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.6)}
  .right{width:360px;background:linear-gradient(180deg,#081726,#08121a);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03)}
  header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  h1{margin:0;font-weight:800;letter-spacing:.6px}
  .sub{opacity:.75;font-size:13px}
  canvas{display:block;width:100%;height:620px;border-radius:10px;background:transparent}
  .panel{margin-top:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;background:linear-gradient(180deg,#06202e,#041422);color:var(--accent)}
  .btn.ghost{background:transparent;color:#cfeefb;border-color:rgba(255,255,255,0.02)}
  .hud{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .stat{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:600}
  .tiny{font-size:12px;opacity:.78}
  .titleSmall{font-size:13px;opacity:.9}
  .palettePreview{height:34px;border-radius:8px;overflow:hidden;display:flex}
  footer{margin-top:12px;text-align:center;color:rgba(255,255,255,0.45);font-size:13px}
  /* menu overlay */
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,8,14,0.6), rgba(2,8,14,0.9));z-index:200}
  .menu{width:920px;max-width:96%;background:linear-gradient(180deg,#041728,#072434);padding:24px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 40px 140px rgba(0,0,0,0.7)}
  .menu h2{margin:6px 0 0 0}
  .menu .cols{display:flex;gap:12px}
  .menu .leftCol{flex:1}
  .menu .rightCol{width:320px}
  .bigBtn{padding:14px 20px;font-size:18px;border-radius:12px;background:linear-gradient(90deg,var(--accent),#6df7c1);border:none;color:#02131a;cursor:pointer;font-weight:700}
  .small{font-size:13px;opacity:.88}
  .muted{opacity:.7;font-size:13px}
  .kbd{background:#021521;padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);font-family:ui-monospace,monospace}
  .list{max-height:220px;overflow:auto;padding-right:6px}
  .lvlItem{padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);cursor:pointer}
  .lvlItem:hover{background:rgba(255,255,255,0.03)}
  .green{color:#7ef7c1}
</style>
</head>
<body>

<!-- MENU / OVERLAYS -->
<div id="menuOverlay" class="overlay">
  <div class="menu" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h2>Chrono Logic ‚Äî Procedural Puzzle Lab</h2><div class="muted">A dynamic puzzle experience ‚Äî every playthrough unique</div></div>
      <div class="tiny">by <b>Krishna Sai Shreyaan Divakaruni</b> ‚Ä¢ Middle Year ‚Äî Game Design</div>
    </div>

    <div style="margin-top:16px" class="cols">
      <div class="leftCol">
        <p class="small">Play modes: <b>Procedural Run</b> (endless levels that increase in difficulty) ‚Äî perfect for judges who want to see design depth.</p>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="bigBtn" id="btnStart">‚ñ∂ Play Now</button>
          <button class="btn ghost" id="btnHow">‚ùì How to Play</button>
          <button class="btn ghost" id="btnCredits">‚≠ê Credits</button>
        </div>

        <h3 style="margin-top:16px">Quick Features</h3>
        <div class="list">
          <div class="lvlItem">‚Ä¢ Procedural puzzle types (Color Sequence, Tile Pattern, Circuit Flow)</div>
          <div class="lvlItem">‚Ä¢ Dynamic neon palettes & particle FX</div>
          <div class="lvlItem">‚Ä¢ Timer, Moves, Score & local leaderboard</div>
          <div class="lvlItem">‚Ä¢ Random mid-level events (scramble, bonus, swap)</div>
          <div class="lvlItem">‚Ä¢ Save/Load & sound toggle</div>
        </div>
      </div>

      <div class="rightCol">
        <div style="display:flex;flex-direction:column;gap:8px">
          <div class="stat">Mode: <b id="menuMode">Procedural</b></div>
          <div class="stat">Session seed: <span id="menuSeed">‚Äî</span></div>
          <div class="stat">Best local score: <span id="bestLocal">0</span></div>
          <div style="margin-top:8px"><small class="muted">Controls: Click tiles, drag where allowed, use on-screen buttons. Audio requires a first click to enable.</small></div>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;margin-top:16px;gap:8px">
      <button class="btn ghost" id="btnDemo">üîÅ Demo Run</button>
      <button class="btn" id="btnStartNow">Start Procedural Run</button>
    </div>
  </div>
</div>

<!-- HOW TO PLAY OVERLAY -->
<div id="howOverlay" class="overlay" style="display:none">
  <div class="menu">
    <h2>How to Play ‚Äî Quick Guide</h2>
    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <p class="small">You will face a sequence of generated puzzles. Each puzzle is one of three core types:</p>
        <ol>
          <li><b>Color-Sequence</b>: Memorize/replicate a color order by clicking tiles.</li>
          <li><b>Tile-Pattern</b>: Toggle tiles to match the hidden pattern. Use logic to propagate flips.</li>
          <li><b>Circuit-Flow</b>: Connect inputs to outputs using logic gates (AND/OR/NOT) or route flows. Place connectors by clicking nodes.</li>
        </ol>
        <p class="small">Tips for judges: speed and efficiency reward you with higher score. Random events can change the puzzle mid-run ‚Äî adapt quickly!</p>
      </div>
      <div style="width:320px">
        <h4>HUD & Controls</h4>
        <ul class="small">
          <li>Timer: how long this puzzle took</li>
          <li>Moves: actions taken</li>
          <li>Score: cumulative session score</li>
          <li>Sound toggle available in the right panel</li>
        </ul>
        <div style="margin-top:8px"><button class="bigBtn" id="btnHowClose">Got it ‚Äî Play</button></div>
      </div>
    </div>
  </div>
</div>

<!-- CREDITS OVERLAY -->
<div id="creditsOverlay" class="overlay" style="display:none">
  <div class="menu">
    <h2>Credits & Design Notes</h2>
    <p class="small">Designed & implemented by <b>Krishna Sai Shreyaan Divakaruni</b> for Design Championship ‚Äî Middle Year (Game Design).</p>
    <p class="small">This entry showcases procedural generation, logic-based puzzles, visual polish, and adaptive challenge ‚Äî designed to highlight game design & systems thinking.</p>
    <div style="display:flex;justify-content:flex-end"><button class="btn" id="btnCreditsClose">Close</button></div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app" id="appRoot" style="display:none">
  <div class="left">
    <header>
      <div>
        <h1>Chrono Logic</h1>
        <div class="sub">Procedural puzzle lab ‚Äî dynamic, colorful, logic-driven</div>
      </div>
      <div style="flex:1"></div>
      <div class="sub">Seed: <span id="seedDisplay">‚Äî</span></div>
    </header>

    <div class="panel">
      <canvas id="mainCanvas" width="1000" height="620"></canvas>
      <div class="hud" style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="stat">Level <span id="levelIdx">1</span></div>
          <div class="stat">Type <span id="levelType">‚Äî</span></div>
          <div class="stat">Timer <span id="hudTimer">0.0s</span></div>
          <div class="stat">Moves <span id="hudMoves">0</span></div>
          <div class="stat">Score <span id="hudScore">0</span></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="palettePreview" id="palettePreview"></div>
          <button class="btn" id="btnPause">Pause</button>
          <button class="btn ghost" id="btnSave">Save</button>
          <button class="btn ghost" id="btnLoad">Load</button>
        </div>
      </div>
    </div>

  </div>

  <div class="right">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="titleSmall">Session</div>
          <div class="muted tiny">Procedural Run</div>
        </div>
        <div style="text-align:right">
          <div class="titleSmall green" id="bestScore">Best: 0</div>
          <div class="muted tiny">Local Best</div>
        </div>
      </div>

      <hr style="opacity:.04;margin:10px 0">

      <div style="display:flex;flex-direction:column;gap:8px">
        <div><button class="btn" id="btnMute">üîä Sound: On</button></div>
        <div><button class="btn ghost" id="btnSkip">‚è≠ Skip Puzzle (costs points)</button></div>
        <div><button class="btn ghost" id="btnResetSession">‚ôªÔ∏è Reset Session</button></div>
      </div>
    </div>

    <div class="panel" style="margin-top:10px">
      <div class="small muted">Live Stats</div>
      <div style="display:flex;flex-direction:column;gap:6px;margin-top:8px">
        <div class="tiny">Current puzzle difficulty: <b id="difficultyLabel">Easy</b></div>
        <div class="tiny">Random events: <b id="eventsLabel">On</b></div>
        <div class="tiny">Palette: <span id="paletteName">‚Äî</span></div>
      </div>
    </div>

    <div class="panel" style="margin-top:10px">
      <div class="small muted">Leaderboard (local)</div>
      <div id="leaderboard" class="list" style="margin-top:8px;max-height:180px;overflow:auto">
        <!-- filled dynamically -->
      </div>
    </div>
  </div>
</div>

<footer style="text-align:center;padding:12px;color:rgba(255,255,255,0.4);font-size:13px">Good luck at the Design Championship ‚Äî build, test, win!</footer>

<script>
/* ------------------------------
   Procedural Puzzle Lab ‚Äî Single file game
   Features:
    - Procedural puzzles: ColorSequence, TilePattern, CircuitFlow
    - Dynamic palettes, particles, audio
    - Timer, moves, score, local leaderboard
    - Random mid-level events
    - Save/Load + Pause + Skip
---------------------------------*/

// Utility
const rand = (a,b)=>a + Math.random()*(b-a);
const randi = (a,b)=>Math.floor(rand(a,b+1));
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const choose=(arr)=>arr[Math.floor(Math.random()*arr.length)];
const uid = ()=>Math.random().toString(36).slice(2,10);

// Global session
let SESSION = {
  seed: Math.floor(Math.random()*1e9),
  rngState: null,
  levelIndex: 0,
  score: 0,
  bestLocal: 0,
  running: false,
  paused: false,
  moves: 0,
  startTime: 0,
  curTimer: 0,
  curPuzzle: null,
  palette: null,
  audioEnabled: false,
  eventsEnabled: true
};

// Simple deterministic RNG for reproducibility per-seed
function makeRNG(seed){
  let s = seed >>> 0;
  return function(){
    s = Math.imul(1664525, s) + 1013904223 | 0;
    return ((s >>> 0) / 4294967296);
  };
}

// Palettes
const PALETTES = [
  {name:'Aqua Neon', colors:['#00f2ff','#6df7c1','#4ec3ff','#0ff']},
  {name:'Vivid Magenta', colors:['#ff4ecd','#ffb86b','#caa7ff','#ff7ab6']},
  {name:'Solar Glow', colors:['#ffd86b','#ff7a59','#ffdf8a','#ffd58a']},
  {name:'Electric Sky', colors:['#7ee7ff','#6df7c1','#9ad0ff','#c6b3ff']}
];

// Canvas & rendering
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
let CANVAS_W = canvas.width, CANVAS_H = canvas.height;
function resizeCanvas(){
  CANVAS_W = canvas.width = canvas.clientWidth * devicePixelRatio;
  CANVAS_H = canvas.height = canvas.clientHeight * devicePixelRatio;
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
resizeCanvas();
window.addEventListener('resize', ()=>{ resizeCanvas(); });

// Particle system
const particles = [];
function spawnParticle(x,y,color,size=4,life=700,vx=0,vy=0){
  particles.push({x,y,vx,vy,color,size,life,age:0});
}
function updateParticles(dt){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.age+=dt;
    if(p.age>p.life){particles.splice(i,1); continue;}
    p.x += p.vx*dt/1000;
    p.y += p.vy*dt/1000;
  }
}
function drawParticles(){
  for(const p of particles){
    const t = 1 - (p.age/p.life);
    ctx.globalAlpha = t;
    ctx.fillStyle = p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.size*t,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
  }
}

/* -------------------------
   Sound: small synth (WebAudio)
--------------------------*/
let AUDIO = {ctx:null, master:null};
function initAudio(){
  if(AUDIO.ctx) return;
  try{
    AUDIO.ctx = new (window.AudioContext || window.webkitAudioContext)();
    AUDIO.master = AUDIO.ctx.createGain();
    AUDIO.master.gain.value = 0.12;
    AUDIO.master.connect(AUDIO.ctx.destination);
  }catch(e){
    AUDIO.ctx = null;
  }
}
function beep(freq, dur=0.08, type='sine'){
  if(!AUDIO.ctx) return;
  const o = AUDIO.ctx.createOscillator();
  const g = AUDIO.ctx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.setValueAtTime(1, AUDIO.ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, AUDIO.ctx.currentTime + dur);
  o.connect(g); g.connect(AUDIO.master);
  o.start(); o.stop(AUDIO.ctx.currentTime + dur);
}

/* -------------------------
   Puzzle types & generator
--------------------------*/
const PUZZLE_TYPES = ['ColorSequence','TilePattern','CircuitFlow'];

// ColorSequence:
//  - grid of colored tiles (nxn). Sequence of lights of length L shown, player repeats by clicking tiles in order.
function generateColorSequence(rng, difficulty){
  const n = clamp(2 + Math.floor(difficulty/2), 2, 5);
  const grid = [];
  for(let y=0;y<n;y++){ const row=[]; for(let x=0;x<n;x++) row.push({colorIndex: randi(0,SESSION.palette.colors.length-1)}); grid.push(row); }
  const seqLen = clamp(3 + Math.floor(difficulty/2), 3, 8);
  const seq = [];
  for(let i=0;i<seqLen;i++){ seq.push({x: randi(0,n-1), y: randi(0,n-1) }); }
  return {type:'ColorSequence', n, grid, seq, playerSeq: [], revealed:false};
}

// TilePattern:
//  - nxn toggle grid. Clicking toggles neighbors (like Lights Out). Generate solvable pattern by applying random toggles starting from empty.
function generateTilePattern(rng, difficulty){
  const n = 3 + (difficulty>2?1:0); // 3 or 4
  // start with all off, apply K random toggles to produce target
  const toggles = [];
  const target = Array.from({length:n}, ()=>Array(n).fill(0));
  const K = 3 + difficulty;
  for(let k=0;k<K;k++){
    const x = randi(0,n-1), y = randi(0,n-1);
    toggles.push({x,y});
    applyToggle(target,x,y);
  }
  // The puzzle: given initial target, player must reach all-zero (or all-on depending design). We'll ask player to match target pattern (light all target cells)
  return {type:'TilePattern', n, target, player: Array.from({length:n}, ()=>Array(n).fill(0)), movesLeft: 10 + difficulty*2};
}
function applyToggle(matrix,x,y){
  const n = matrix.length;
  const dx = [0,1,-1,0,0], dy = [0,0,0,1,-1];
  for(let i=0;i<dx.length;i++){
    const nx = x+dx[i], ny=y+dy[i];
    if(nx>=0 && nx<n && ny>=0 && ny<n) matrix[ny][nx] = 1 - matrix[ny][nx];
  }
}

// CircuitFlow:
//  - small node graph: inputs, gates, outputs. Player must connect wires by clicking pairs of nodes. For complexity, we'll present a preconnected graph with missing wires.
function generateCircuitFlow(rng, difficulty){
  // simple: inputs (1-2), one gate (AND/OR/NOT) optionally, one output. Represent nodes with positions.
  const inputs = 1 + Math.floor(difficulty/2);
  const gates = Math.min(1 + Math.floor(difficulty/2), 3);
  const nodes = [];
  // layout nodes on left (inputs), middle (gates), right (output)
  for(let i=0;i<inputs;i++) nodes.push({id: 'in'+i, type:'IN', x:100, y:120 + i*90});
  for(let g=0; g<gates; g++){
    const kind = choose(['AND','OR','XOR','NOT']);
    nodes.push({id:'g'+g, type:kind, x:350, y:100 + g*100});
  }
  nodes.push({id:'out0', type:'OUT', x:700, y:160});
  // wires: create desired links from all inputs to gates and gates to out, then remove some to create puzzle
  let links = [];
  // connect all inputs to gate0, gate i to gate i+1, last gate to out
  if(gates===0){
    // connect inputs directly to out (if multiple, require OR logic simulated)
    inputsLoop: for(let i=0;i<inputs;i++) links.push({from:'in'+i, to:'out0'});
  } else {
    for(let i=0;i<inputs;i++) links.push({from:'in'+i, to:'g0'});
    for(let j=0;j<gates-1;j++) links.push({from:'g'+j, to:'g'+(j+1)});
    links.push({from:'g'+(gates-1), to:'out0'});
  }
  // now remove a set of links to create missing connections puzzle
  const missingCount = clamp(1 + Math.floor(difficulty/2),1,links.length-1);
  const removed = [];
  for(let k=0;k<missingCount;k++){
    const idx = randi(0,links.length-1);
    removed.push(links[idx]);
    links.splice(idx,1);
  }
  return {type:'CircuitFlow', nodes, links, missing: removed, placed: []};
}

/* -------------------------
  High-level procedural generator
--------------------------*/
function generatePuzzle(seed, level){
  const rng = makeRNG(seed + level*997);
  const difficulty = Math.min(1 + Math.floor(level/2), 6);
  const type = choose(PUZZLE_TYPES);
  if(type==='ColorSequence') return generateColorSequence(rng,difficulty);
  if(type==='TilePattern') return generateTilePattern(rng,difficulty);
  if(type==='CircuitFlow') return generateCircuitFlow(rng,difficulty);
  return generateColorSequence(rng,difficulty);
}

/* -------------------------
   Rendering puzzles
--------------------------*/
function clearScreen(){
  ctx
